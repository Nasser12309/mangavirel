<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-1763885261035018">
    <title id="page-title">عرض محتوى الفصل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            background-color: #390311;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            color: #fff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-bar {
            background-color: #982F1F;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-arrow-group { display: flex; gap: 10px; order: 1; }
        .back-arrow { font-size: 24px; color: #fff; cursor: pointer; }
        .button-container { display: flex; gap: 10px; order: 2; }

        .nav-button {
            background-color: transparent;
            color: #fff;
            border: 2px solid #fff;
            padding: 5px 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .nav-button:hover { background-color: rgba(255, 0, 0, 0.2); }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .image-viewer-container {
            flex-grow: 1; margin: 0; overflow-y: auto; background-color: #121212;
            padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 300px;
        }
        .content-wrapper { text-align: center; width: 100%; max-width: 800px; padding: 0; }
        .chapter-image { max-width: 100%; height: auto; display: block; margin: 0 auto; vertical-align: top; }
        .loading-indicator { color: #fff; padding: 20px; font-size: 16px; text-align: center; }
        .teil { height: 15px; display: flex; align-items: center; justify-content: center; }
        .teil h3 { margin: 0; color: #fff; padding-top: 15px; font-size: 15px; }
        .error-msg { color: #ff4444; background: #330000; padding: 15px; margin: 10px; border: 1px solid red; direction: ltr; text-align: left; }

        /* ========================================== */
        /* 1. إضافة CSS الخاص بنافذة الإعلان (جديد) */
        /* ========================================== */
        .ad-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 10000; /* يجب أن يكون أعلى من Top Bar */
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .ad-overlay.active { display: flex; }
        .ad-content {
            width: 90%; max-width: 600px; background: #1a1a1a; padding: 15px;
            border-radius: 10px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.3); text-align: center;
        }
        .ad-video { width: 100%; border-radius: 8px; margin: 15px 0; background: #000; max-height: 60vh; }
        .ad-header { display: flex; justify-content: space-between; color: #fff; font-weight: bold; margin-bottom: 10px; direction: rtl; }
        .ad-header span:first-child { color: #ffcc00; background: rgba(255, 255, 0, 0.1); padding: 2px 8px; border-radius: 4px; }
        #ad-timer { color: #c9c9c9; font-size: 14px; }
        .ad-footer { color: #888; font-size: 12px; margin-top: 10px; }

    </style>
</head>
<body>

  <div class="top-bar">
    <div class="back-arrow-group">
        <i id="back-to-details" class="fas fa-arrow-right back-arrow"></i>
        <i id="home-button" class="fas fa-home back-arrow"></i>
          <div class="teil">
       <h3 id="chapter-title">جاري التحميل...</h3>
    </div>
    </div>

    <div class="button-container">
        <button id="next-chapter-btn" class="nav-button">الفصل التالي</button>
        <button id="prev-chapter-btn" class="nav-button">الفصل السابق</button>
    </div>
</div>

    <div id="image-viewer" class="image-viewer-container">
        <div id="content-wrapper" class="content-wrapper"></div>
        <div id="loading-status" class="loading-indicator"></div>
    </div>

    <div id="ad-overlay" class="ad-overlay">
        <div class="ad-content">
            <div class="ad-header">
                <span>إعلان ممول</span>
                <span id="ad-timer">يجب مشاهدة الفيديو للإنتقال...</span>
            </div>
            <video id="ad-video" class="ad-video" playsinline controls>
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                متصفحك لا يدعم تشغيل الفيديو.
            </video>
            <div class="ad-footer">
                سيتم عرض الفصل تلقائياً بعد انتهاء الفيديو
            </div>
        </div>
    </div>

<script>
    function getProjectData(id) {
         const ALL_PROJECTS = {
            'Nano-Machine': { title: 'نانو ماشين', totalChapters: 6, folderType: 'manhua' },
            'Demon-Slayer': { title: 'قاتل الشياطين', totalChapters: 100, folderType: 'manga' },
            'One-Piece': { title: 'One Piece', totalChapters: 1100, folderType: 'manga' },
            'Reverend-insanity': { title: 'Reverend insanity', totalChapters: 50, folderType: 'manhua' },
            'venom': { title: 'Venom', totalChapters: 6, folderType: 'comic' },
         };
         const data = ALL_PROJECTS[id] || {
             title: id ? id.replace(/-/g, ' ') : 'محتوى غير معروف',
             totalChapters: 200, 
             folderType: 'manhua' 
         };
         return data;
    }

    function getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id') ? decodeURIComponent(urlParams.get('id')) : null;
        const chapterNumber = parseInt(urlParams.get('chapter'));
        return {
            id: id,
            chapter: !isNaN(chapterNumber) && chapterNumber > 0 ? chapterNumber : 1
        };
    }

    const { id: currentProjectId, chapter: currentChapterNumber } = getUrlParams();
    const projectData = getProjectData(currentProjectId);
    let currentChapterIndex = currentChapterNumber - 1;

    const container = document.getElementById('content-wrapper');
    const loadingStatus = document.getElementById('loading-status');
    const chapterTitleElement = document.getElementById('chapter-title');
    const nextButton = document.getElementById('next-chapter-btn');
    const prevButton = document.getElementById('prev-chapter-btn');
    const imageViewer = document.getElementById('image-viewer'); // نحتاجه لإعادة التمرير للأعلى

    // ===============================================
    // 3. دالة تشغيل الإعلان (Logic)
    // ===============================================
    // هذه الدالة تستقبل "callback" وهو ما سيحدث بعد انتهاء الفيديو
    function playAd(onAdFinishedCallback) {
        const adOverlay = document.getElementById('ad-overlay');
        const adVideo = document.getElementById('ad-video');
        const adTimer = document.getElementById('ad-timer');

        adOverlay.classList.add('active');
        
        // محاولة التشغيل
        adVideo.currentTime = 0;
        adVideo.play().catch(e => console.log("Autoplay prevented"));

        adVideo.ontimeupdate = function() {
            const timeLeft = Math.ceil(adVideo.duration - adVideo.currentTime);
            if(!isNaN(timeLeft)) {
                adTimer.innerText = `باقي ${timeLeft} ثانية...`;
            }
        };

        adVideo.onended = function() {
            adTimer.innerText = "جاري تحميل الفصل...";
            setTimeout(() => {
                adOverlay.classList.remove('active');
                // هنا يتم تنفيذ الأمر (الانتقال للفصل التالي)
                if (onAdFinishedCallback) onAdFinishedCallback();
            }, 500);
        };
    }

    function renderChapterImages() {
        updateChapterTitle();
        updateButtonState();
        container.innerHTML = '';
        loadingStatus.innerText = 'جاري بدء تحميل الصور...';

        // إعادة التمرير إلى أعلى الصفحة عند تغيير الفصل
        imageViewer.scrollTop = 0;
        window.scrollTo(0, 0);

        let baseDir;
        if (projectData.folderType === 'comic') {
            baseDir = 'Comic_Files';
        } else if (projectData.folderType === 'manga') {
            baseDir = 'Manga_Files';
        } else {
            baseDir = 'Manhua_Files'; 
        }
        
        const cleanProjectId = currentProjectId ? currentProjectId.replace(/^\/|\/$/g, '') : '';
        loadNextImage(1, baseDir, cleanProjectId);
    }

    function loadNextImage(index, baseDir, projectId) {
        const chapterFolder = `ch${currentChapterIndex + 1}`;
        const fileName = `img_${String(index).padStart(3, '0')}.webp`;
        const path = `${baseDir}/${projectId}/${chapterFolder}/${fileName}`;

        const img = new Image();
        img.onload = function() {
            img.className = 'chapter-image';
            img.alt = `صفحة ${index}`;
            container.appendChild(img);
            loadingStatus.innerText = `تم تحميل ${index} صورة... جاري البحث عن المزيد`;
            loadNextImage(index + 1, baseDir, projectId);
        };
        img.onerror = function() {
            if (index === 1) {
                loadingStatus.innerHTML = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-msg';
                errorDiv.innerHTML = `<strong>❌ تعذر العثور على الصور!</strong><br><code>${path}</code>`;
                container.appendChild(errorDiv);
            } else {
                loadingStatus.innerText = '--- نهاية الفصل ---';
            }
        };
        img.src = path;
    }

    function updateChapterTitle() {
        if (projectData) {
             const titleText = `${projectData.title} - الفصل ${currentChapterIndex + 1}`;
             chapterTitleElement.innerText = titleText;
             document.getElementById('page-title').innerText = titleText;
        }
    }

    function updateButtonState() {
        prevButton.disabled = (currentChapterIndex <= 0);
        nextButton.disabled = false; 
        const newUrl = `?id=${currentProjectId}&chapter=${currentChapterIndex + 1}`;
        window.history.replaceState({ path: newUrl }, '', newUrl);
    }

    document.getElementById('back-to-details').addEventListener('click', () => {
        window.location.href = `show_details.html?id=${currentProjectId}`;
    });
    document.getElementById('home-button').addEventListener('click', () => {
        window.location.href = 'index.html';
    });

    // ===============================================
    // 4. ربط زر التالي بالإعلان
    // ===============================================
    nextButton.addEventListener('click', () => {
        // بدلاً من الانتقال مباشرة، نقوم بتشغيل الإعلان أولاً
        playAd(function() {
            // هذا الكود سيعمل فقط بعد انتهاء الفيديو
            currentChapterIndex++;
            renderChapterImages();
        });
    });

    prevButton.addEventListener('click', () => {
        if (currentChapterIndex > 0) {
            currentChapterIndex--;
            renderChapterImages();
        }
    });

    renderChapterImages();

</script>

</body>
</html>
