<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>صفحة الملف الشخصي</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary-color: #ff3d00;
    --background-dark: #000000;
    --text-active: #fff;
    --text-secondary: #fff;
    --bio-background: #3E0413;
    --male-color: #3897f0;
    --female-color: #ff69b4;
  }

  body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    padding-top: 15px;
    background-color: #822F1F;
    color: var(--text-active);
    text-align: right;
    direction: rtl;
    padding-bottom: 80px;
  }

  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 70px;
    background-color:#C04236;
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: 0 -2px 15px rgba(0,0,0,0.5);
    z-index: 1000;
  }

  .bottom-nav a {
    color: white;
    text-decoration: none;
    font-size: 9px;
    text-align: center;
    flex-grow: 1;
    transition: color 0.3s ease;
    padding: 10px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .bottom-nav a.active {
      color: #072F1F;
  }

  .bottom-nav a i {
    display: block;
    font-size: 20px;
    margin-bottom: 3px;
    transition: font-size 0.3s ease;
  }

  .profile-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
    padding-bottom: 20px;
    margin: 0 15px;
  }

  .avatar-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin-bottom: 10px;
  }

  .avatar-label {
      display: block;
      cursor: pointer;
      width: 100%;
      height: 100%;
  }

  .avatar {
    width: 100px;
    height: 100px;
    background-color: #333;
    border-radius: 50%;
    overflow: hidden;
    display: flex;
    justify: center;
    align-items: center;
    position: absolute;
    top: 0;
    left: 0;
  }

  .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }

  .name-and-gender {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
  }

  .username {
    font-size: 26px;
    font-weight: bold;
    margin-bottom: 0;
    margin-inline-end: 10px;
  }

  .gender-display-span {
      font-size: 20px;
      display: none;
  }

  .status-info {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 15px;
  }

  .profile-details-container {
      width: 100%;
      max-width: 400px;
      text-align: center;
  }

  .bio-box {
      background-color: none;
      color: var(--text-active);
      font-size: 15px;
      padding: 15px;
      border-radius: 8px;
      text-align:center;
      line-height: 0.3;
      margin-bottom: 15px;
      white-space: pre-wrap;
  }

  .date-of-birth {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .date-of-birth i {
      margin-inline-end: 8px;
      font-size: 16px;
  }


  .edit-button {
    background-color: #131213;
    color: var(--text-active);
    padding: 10px 40px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    margin-bottom: 30px;
    transition: background-color 0.3s;
    text-decoration: none;
    display: inline-block;
  }

  .edit-button:hover {
      background-color: #131213;
  }

  .content-section {
    padding: 0 15px 20px 15px;
  }

  .section-title {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-title a {
      font-size: 14px;
      color: var(--text-secondary);
      text-decoration: none;
  }

  .posters-grid {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 15px;
    -ms-overflow-style: none;
    scrollbar-width: none;
    padding-left: 15px;
    /* For centered message if empty */
    align-items: center; 
  }
  .posters-grid::-webkit-scrollbar {
    display: none;
  }

  .posters-grid a.poster-item {
      flex-shrink: 0;
      width: calc(33.33% - 7px);
      max-width: 120px;
      aspect-ratio: 2/3;
      border-radius: 5px;
      overflow: hidden;
      background-color: #333;
      object-fit: cover;
      display: block;
      text-decoration: none;
  }

  .posters-grid a.poster-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }

  .spacer {
      height: 30px;
  }
</style>
</head>
<body >
    <div class="profile-section">
        <div class="avatar-container">

            <input type="file" id="avatar-upload" style="display: none;" accept="image/*">

            <div class="avatar-label" >
                <div class="avatar">
                    <img
                        src="https://i.ibb.co/L8B8j4q/noctis-avatar.jpg"
                        alt="صورة الملف الشخصي"
                        id="current-avatar">
                </div>
            </div>


        </div>

        <div class="name-and-gender">
            <p class="username" id="display-name">القارئ المميز</p> <span class="gender-display-span" id="gender-display-icon"></span>
        </div>

        <p class="status-info" id="display-username">@username</p> <div class="profile-details-container">
            <div class="bio-box" id="display-bio">
                النبذة الشخصية</div>

            <div class="date-of-birth">
                <i class="fas fa-calendar-alt"></i> <span id="display-dob">1990/01/01</span>
            </div>
        </div>

        <a href="edit-profile.html" class="edit-button" onclick="saveCurrentProfileData()">تعديل الملف الشخصي</a>
    </div>

<div class="content-section">
    <div class="section-title">
        سجل القراءة

    </div>
    <div class="posters-grid" id="reading-history-grid">
        </div>

    <div class="spacer"></div>
</div>

<div class="bottom-nav">
      <a href="index.html" ><i class="fas fa-home"></i>الرئيسية</a>

      <a href="news.html"><i class="fas fa-fire"></i>آخر التحديثات</a>

      <a href="manga.html"><i class="fas fa-book-open"></i>المانجا</a>
      <a href="manhua.html"><i class="fas fa-scroll"></i>المانهوا</a>
      <a href="profile-view.html" class="active"><i class="fas fa-user"></i>الملف الشخصي</a>
</div>
<script>
    function saveCurrentProfileData() {
        const profileData = {
            name: document.getElementById('display-name').textContent,
            username: document.getElementById('display-username').textContent.replace('@', ''),
            bio: document.getElementById('display-bio').textContent,
            dob: document.getElementById('display-dob').textContent,
            gender: 'male',
            image: document.getElementById('current-avatar').src
        };

        localStorage.setItem('profileData', JSON.stringify(profileData));
        console.log("تم حفظ بيانات الملف الشخصي.");
    }

    document.getElementById('avatar-upload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('current-avatar').src = e.target.result;
                saveCurrentProfileData();
            }
            reader.readAsDataURL(file);
        }
    });

    function loadProfileData() {
        const savedDataJSON = localStorage.getItem('profileData');
        const defaultImage = document.getElementById('current-avatar').src;

        if (!savedDataJSON) {
            saveCurrentProfileData();
            renderReadingHistory(); 
            return;
        }

        try {
            const savedData = JSON.parse(savedDataJSON);

            document.getElementById('display-name').textContent = savedData.name || 'الاسم';

            document.getElementById('display-username').textContent = '@' + (savedData.username || 'اسم المستخدم');

            document.getElementById('display-bio').textContent = savedData.bio || 'لم يتم إضافة نبذة بعد.';

            document.getElementById('display-dob').textContent = savedData.dob || 'غير محدد';

            const genderDisplaySpan = document.getElementById('gender-display-icon');

            if (savedData.gender === 'male') {
                genderDisplaySpan.textContent = '♂️';
                genderDisplaySpan.style.display = 'inline-block';
            } else if (savedData.gender === 'female') {
                genderDisplaySpan.textContent = '♀️';
                genderDisplaySpan.style.display = 'inline-block';
            } else {
                genderDisplaySpan.textContent = '';
                genderDisplaySpan.style.display = 'none';
            }

            if (savedData.image) {
                document.getElementById('current-avatar').src = savedData.image;
            } else {
                document.getElementById('current-avatar').src = defaultImage;
            }

        } catch (e) {
            console.error("خطأ في تحليل بيانات LocalStorage:", e);
        }

        renderReadingHistory(); 
    }

    // *تم تعديل الدالة لاستخدام مفتاح 'readHistory' والفرز حسب 'lastRead'*
    function renderReadingHistory() {
        // **تصحيح المفتاح إلى 'readHistory' ليتوافق مع ملف show_details.html**
        const HISTORY_KEY = 'readHistory'; 
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        const grid = document.getElementById('reading-history-grid');

        // 1. مسح المحتوى الحالي 
        grid.innerHTML = '';

        if (history.length === 0) {
            // عرض رسالة في حال كان السجل فارغاً
            const message = document.createElement('p');
            message.textContent = 'لم تقم بزيارة أي محتوى بعد.';
            message.style.textAlign = 'center';
            message.style.color = 'var(--text-secondary)';
            message.style.width = '100%';
            grid.appendChild(message);
            grid.style.justifyContent = 'center';
        } else {
            grid.style.justifyContent = 'flex-start';

            // **2. الفرز لضمان ظهور آخر قراءة في البداية**
            history.sort((a, b) => {
                // الفرز بناءً على قيمة lastRead بترتيب تنازلي (الأحدث أولاً)
                return new Date(b.lastRead) - new Date(a.lastRead);
            });

            // 3. إنشاء بطاقة لكل عنصر في السجل
            history.forEach(item => {
                const card = document.createElement('a');
                // توجيه الرابط لصفحة التفاصيل مع مُعرِّف المحتوى
                card.href = `show_details.html?id=${item.id}`;
                card.className = 'poster-item';
                
                // التأكد من استخدام المسار المخزن (يفترض أنه مطلق أو نسبي صحيح)
                const imagePath = item.image; 

                // استخدام صورة المحتوى المسجلة
                card.innerHTML = `<img src="${imagePath}" alt="غلاف ${item.id}">`;
                grid.appendChild(card);
            });
        }
    }


    document.addEventListener('DOMContentLoaded', loadProfileData);

</script>

</body>
</html>
